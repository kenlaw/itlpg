<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>iClass æ•™æ¡ˆè£½ä½œå¤§å¸«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.1.1/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .studio-container { max-width: 1100px; margin: 30px auto; flex-grow: 1; width: 100%; }
        .paper-landscape { 
            background: white; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border-radius: 8px; min-height: 800px;
        }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
        td { border: 1px solid #000; padding: 10px; vertical-align: top; }
        .bg-header { background-color: #d1d5db; font-weight: bold; color: #000; }
        
        [contenteditable="true"] { outline: none; padding: 4px; transition: all 0.2s; border-radius: 2px; border: 1px dashed transparent; }
        [contenteditable="true"]:hover { background-color: #eff6ff; border-color: #93c5fd; }
        [contenteditable="true"]:focus { background-color: #fff; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        [contenteditable="true"]:empty:before { content: attr(placeholder); color: #9ca3af; pointer-events: none; }
        
        .btn-main { background: #2563eb; color: white; padding: 10px 24px; border-radius: 6px; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; cursor: pointer; }
        .btn-main:hover { background: #1d4ed8; }
        .btn-import { background: white; border: 2px solid #2563eb; color: #2563eb; padding: 8px 20px; border-radius: 6px; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; cursor: pointer; }
        .btn-import:hover { background: #eff6ff; }
        .btn-add { color: #059669; font-weight: bold; cursor: pointer; margin-top: 10px; display: inline-flex; align-items: center; padding: 5px 10px; border-radius: 4px; }
        .delete-row { color: #dc2626; cursor: pointer; font-size: 18px; font-weight: bold; padding: 4px 8px; }

        #importModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 14px; margin: 15px 0; resize: vertical; }
        textarea:focus { outline: 2px solid #2563eb; border-color: transparent; }
        .error-box { background: #fee2e2; color: #b91c1c; padding: 10px; border-radius: 6px; font-size: 14px; margin-bottom: 10px; display: none; }
        .success-msg { color: #059669; font-size: 14px; margin-top: 5px; display: none; }
        
        .footer-credit { text-align: center; color: #9ca3af; font-size: 0.875rem; padding: 20px 0; margin-top: auto; }
    </style>
</head>
<body>

<div class="bg-white shadow-sm border-b sticky top-0 z-50 p-4">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800 flex items-center">
                <span class="text-2xl mr-2">ğŸ¨</span> iClass æ•™æ¡ˆè£½ä½œå¤§å¸«
            </h1>
            <p class="text-xs text-gray-500 mt-1 ml-9 font-medium">Developed by Ken Law</p>
        </div>
        <div class="flex gap-4">
            <button onclick="openModal()" class="btn-import">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                åŒ¯å…¥ AI æ•¸æ“š
            </button>
            <button id="exportBtn" class="btn-main">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                ä¸‹è¼‰ Word (.docx)
            </button>
        </div>
    </div>
</div>

<div id="importModal" class="flex">
    <div class="modal-content">
        <h2 class="text-xl font-bold text-gray-800 mb-1">åŒ¯å…¥ AI ç”Ÿæˆçš„æ•¸æ“š</h2>
        <p class="text-sm text-gray-600">è«‹è²¼ä¸Š JSON ä»£ç¢¼ã€‚ç³»çµ±æœƒè‡ªå‹•é€²è¡Œå…§å®¹æ¸…æ´—èˆ‡æ ¼å¼åŒ–ã€‚</p>
        <textarea id="jsonInput" placeholder='{ "topic": "...", "flow": [...] }' oninput="resetError()"></textarea>
        <div id="errorBox" class="error-box">
            <p id="errorText" class="font-bold"></p>
            <button onclick="autoFixJSON()" class="mt-2 bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold hover:bg-red-200 border border-red-300">âœ¨ å¼·åŠ›ä¿®å¾© (Fix & Clean)</button>
        </div>
        <div id="successMsg" class="success-msg font-bold">âœ… æ ¼å¼æ­£ç¢ºï¼æº–å‚™åŒ¯å…¥...</div>
        <div class="flex justify-end gap-3 mt-2">
            <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">å–æ¶ˆ</button>
            <button onclick="processData()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow">é–‹å§‹è£½ä½œ</button>
        </div>
    </div>
</div>

<div class="studio-container">
    <div class="paper-landscape">
        <div id="lessonForm">
            <!-- Header Info -->
            <table>
                <tr>
                    <td class="bg-header w-24">ç§‘ç›®</td>
                    <td contenteditable="true" id="subject" placeholder="[è«‹è¼¸å…¥ç§‘ç›®]"></td>
                    <td class="bg-header w-32">å»ºè­°å­¸ç¿’å¹´ç´š</td>
                    <td contenteditable="true" id="grade" placeholder="[è«‹è¼¸å…¥å¹´ç´š]"></td>
                </tr>
                <tr>
                    <td class="bg-header">èª²é¡Œ</td>
                    <td contenteditable="true" id="topic" placeholder="[è«‹è¼¸å…¥èª²é¡Œåç¨±]"></td>
                    <td class="bg-header">æ•™å­¸å·¥å…·</td>
                    <td contenteditable="true" id="tools" placeholder="[è«‹è¼¸å…¥ç¡¬ä»¶/è»Ÿä»¶]"></td>
                </tr>
            </table>

            <!-- Objectives & Resources -->
            <table>
                <tr>
                    <td class="bg-header w-1/2">å­¸ç¿’ç›®æ¨™</td>
                    <td class="bg-header w-1/2">æ•™å­¸è³‡æº</td>
                </tr>
                <tr>
                    <td contenteditable="true" id="objectives" placeholder="1. ..."></td>
                    <td contenteditable="true" id="resources" placeholder="1. å½±ç‰‡ï¼š...&#10;2. å·¥ä½œç´™ï¼š..."></td>
                </tr>
                <tr>
                    <td class="bg-header">å­¸ç”Ÿå·²æœ‰çŸ¥è­˜</td>
                    <td contenteditable="true" id="priorKnowledge" colspan="3" placeholder="[ä¾‹å¦‚ï¼šç„¡]"></td>
                </tr>
                <tr>
                    <td class="bg-header">å»ºè­°èª²ç¯€</td>
                    <td contenteditable="true" id="duration" colspan="3" placeholder="[ä¾‹å¦‚ï¼šå…± 1 ç¯€æˆ– 2 ç¯€ï¼›æ¯ç¯€ 35 åˆ†é˜]"></td>
                </tr>
            </table>

            <!-- Flow -->
            <h3 class="font-bold text-lg mb-3 text-gray-700 border-l-4 border-blue-600 pl-3">ç¬¬ä¸€æ•™ç¯€å¤§ç¶±</h3>
            <table id="flowTable">
                <tr class="bg-header text-center">
                    <td style="width: 10%">æ™‚é–“</td>
                    <td style="width: 65%">æ•™å­¸æµç¨‹</td> 
                    <td style="width: 20%">å‚™è¨»</td>
                    <td style="width: 5%" class="border-none bg-white"></td>
                </tr>
                <tr class="flow-row">
                    <td contenteditable="true" class="text-center row-time" placeholder="5 åˆ†é˜"></td>
                    <td>
                        <div contenteditable="true" class="font-bold row-title" placeholder="[æ­¥é©Ÿæ¨™é¡Œ]"></div>
                        <div contenteditable="true" class="row-content" placeholder="1. å…§å®¹æè¿°..."></div>
                    </td>
                    <td contenteditable="true" class="row-note" placeholder="[é€£çµ / è³‡æº]"></td>
                    <td class="border-none text-center align-middle"><span class="delete-row" onclick="removeRow(this)">Ã—</span></td>
                </tr>
            </table>
            
            <div id="addBtnContainer">
                <span class="btn-add" onclick="addNewRow()">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    å¢åŠ æ•™å­¸æ­¥é©Ÿ
                </span>
            </div>

            <!-- Footer -->
            <table class="mt-8">
                <tr>
                    <td class="bg-header w-32">æ•™å¸«è©•ä¼°</td>
                    <td contenteditable="true" id="assessment" placeholder="[è©•ä¼°æ–¹å¼...]"></td>
                </tr>
            </table>
        </div>
    </div>
    
    <div class="footer-credit">Developed by Ken Law</div>
</div>

<script>
    const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, HeadingLevel, AlignmentType, PageOrientation, VerticalAlign, BorderStyle } = docx;

    function openModal() { document.getElementById('importModal').style.display = 'flex'; document.getElementById('jsonInput').focus(); }
    function closeModal() { document.getElementById('importModal').style.display = 'none'; resetError(); }
    function resetError() { document.getElementById('errorBox').style.display = 'none'; document.getElementById('successMsg').style.display = 'none'; }

    function addNewRow(time = "", title = "", content = "", note = "") {
        const table = document.getElementById('flowTable');
        const row = document.createElement('tr');
        row.className = "flow-row";
        row.innerHTML = `
            <td contenteditable="true" class="text-center row-time">${time}</td>
            <td>
                <div contenteditable="true" class="font-bold row-title">${title}</div>
                <div contenteditable="true" class="row-content">${content}</div>
            </td>
            <td contenteditable="true" class="row-note">${note}</td>
            <td class="border-none text-center align-middle"><span class="delete-row" onclick="removeRow(this)">Ã—</span></td>
        `;
        table.appendChild(row);
    }

    function removeRow(btn) {
        const row = btn.closest('tr');
        if (document.querySelectorAll('.flow-row').length > 1) row.remove();
        else { ['row-time','row-title','row-content','row-note'].forEach(c=>row.querySelector('.'+c).innerText=''); }
    }

    function autoFixJSON() {
        let str = document.getElementById('jsonInput').value;
        str = str.replace(/\[cite[^\]]*\]/g, ""); 
        str = str.replace(/\[cite_start\]/g, "");
        str = str.replace(/\[cite_end\]/g, "");
        str = str.replace(/\*\*/g, ""); 
        str = str.replace(/([^\,\{\}\[\]\s])\s*\n\s*([^\s\{\}\[\]])/g, "$1\\n$2");
        str = str.replace(/â€œ/g, '"').replace(/â€/g, '"');
        document.getElementById('jsonInput').value = str;
        processData(true);
    }

    function processData(isRetry = false) {
        const jsonStr = document.getElementById('jsonInput').value;
        if (!jsonStr.trim()) return;

        try {
            const data = JSON.parse(jsonStr);
            const setT = (id, k) => { if(data[k]) document.getElementById(id).innerText = data[k]; };
            const setH = (id, k) => { 
                if(data[k]) {
                    // v9.3 å¼·åŠ›æ¸…æ´—ï¼šç§»é™¤èª²æœ¬ã€æ•™æã€ç¡¬ä»¶ï¼Œä»¥åŠ "ç¬¬ xx é "
                    let cleanContent = data[k]
                        .replace(/å­¸èˆ‡æ•™è³‡æº[:ï¼š]?/g, "")
                        .replace(/<strong>å­¸èˆ‡æ•™è³‡æº<\/strong>/g, "")
                        .replace(/å¹³æ¿é›»è…¦/g, "")
                        .replace(/iPad/gi, "")
                        .replace(/é›»è…¦/g, "")
                        .replace(/PhotoGrid/gi, "")
                        .replace(/Sketchpad/gi, "")
                        .replace(/æ‡‰ç”¨ç¨‹å¼/g, "")
                        .replace(/é›»å­èª²æœ¬/g, "")
                        .replace(/èª²æœ¬/g, "")
                        .replace(/æ•™æ/g, "")
                        .replace(/æ•™å­¸ç°¡å ±/g, "")
                        .replace(/ç°¡å ±/g, "")
                        .replace(/PDF/gi, "")
                        .replace(/ç¬¬\s*\d+\s*é /g, "") // ç§»é™¤é ç¢¼å¼•ç”¨
                        .replace(/P\.\d+/gi, "") // ç§»é™¤ P.xx
                        .replace(/ã€\s*ã€/g, "ã€")
                        .replace(/^\s*ã€/g, "")
                        .replace(/ã€\s*$/g, "")
                        .replace(/\(.*\)/g, "")
                        .replace(/^\d+\.\s*$/gm, "")
                        .trim();
                    document.getElementById(id).innerHTML = cleanContent; 
                }
            };

            setT('subject', 'subject'); setT('grade', 'grade'); 
            setT('topic', 'topic'); 
            setT('tools', 'tools');
            
            setT('objectives', 'objectives'); setH('resources', 'resources');
            setT('priorKnowledge', 'priorKnowledge'); setT('duration', 'duration');
            setT('assessment', 'assessment');

            if (data.flow && data.flow.length > 0) {
                const tbl = document.getElementById('flowTable');
                while(tbl.rows.length > 1) tbl.deleteRow(1);
                data.flow.forEach(f => addNewRow(f.time, f.title, f.content, f.note));
            }
            
            document.getElementById('successMsg').style.display = 'block';
            setTimeout(() => { closeModal(); alert("âœ… åŒ¯å…¥æˆåŠŸï¼"); }, 500);
            
        } catch(e) {
            const errBox = document.getElementById('errorBox');
            document.getElementById('errorText').innerText = "âŒ æ ¼å¼éŒ¯èª¤ï¼š" + e.message;
            errBox.style.display = 'block';
        }
    }

    function createCell(text, bold = false, fill = null, align = AlignmentType.LEFT) {
        return new TableCell({
            children: [new Paragraph({ children: [new TextRun({ text, bold })], alignment: align })],
            shading: fill ? { fill } : undefined,
            verticalAlign: VerticalAlign.CENTER
        });
    }

    document.getElementById('exportBtn').onclick = async () => {
        const getT = (id) => document.getElementById(id).innerText;
        
        const doc = new Document({
            sections: [{
                properties: { page: { size: { orientation: PageOrientation.LANDSCAPE }, margin: { top: 720, right: 720, bottom: 720, left: 720 } } },
                children: [
                    new Paragraph({ text: (getT('topic') || "æ•™æ¡ˆ") + " - æ•™æ¡ˆ", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 200 } }),
                    
                    // Table 1: Info
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({ children: [ 
                                createCell("ç§‘ç›®", true, "E5E7EB"), createCell(getT('subject')), 
                                createCell("å»ºè­°å­¸ç¿’å¹´ç´š", true, "E5E7EB"), createCell(getT('grade')) 
                            ]}),
                            new TableRow({ children: [ 
                                createCell("èª²é¡Œ", true, "E5E7EB"), createCell(getT('topic')), 
                                createCell("æ•™å­¸å·¥å…·", true, "E5E7EB"), createCell(getT('tools')) 
                            ]})
                        ]
                    }),
                    new Paragraph({ text: "" }),
                    
                    // Table 2: Objectives
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({ children: [ createCell("å­¸ç¿’ç›®æ¨™", true, "E5E7EB"), createCell("æ•™å­¸è³‡æº", true, "E5E7EB") ]}),
                            new TableRow({ children: [
                                new TableCell({ children: getT('objectives').split('\n').map(l => new Paragraph({ text: l, spacing: { after: 50 } })) }),
                                new TableCell({ children: getT('resources').split('\n').map(l => new Paragraph({ text: l, spacing: { after: 50 } })) })
                            ]}),
                            new TableRow({ children: [ createCell("å­¸ç”Ÿå·²æœ‰çŸ¥è­˜", true, "E5E7EB"), new TableCell({ children: [new Paragraph(getT('priorKnowledge'))], columnSpan: 3 }) ]}),
                            new TableRow({ children: [ createCell("å»ºè­°èª²ç¯€", true, "E5E7EB"), new TableCell({ children: [new Paragraph(getT('duration'))], columnSpan: 3 }) ]})
                        ]
                    }),
                    
                    new Paragraph({ text: "ç¬¬ä¸€æ•™ç¯€å¤§ç¶±", bold: true, spacing: { before: 200, after: 100 } }),
                    
                    // Table 3: Flow
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({ children: [ 
                                createCell("æ™‚é–“", true, "E5E7EB", AlignmentType.CENTER), 
                                createCell("æ•™å­¸æµç¨‹", true, "E5E7EB"), 
                                createCell("å‚™è¨»", true, "E5E7EB") 
                            ]}),
                            ...Array.from(document.querySelectorAll('.flow-row')).map(row => {
                                const time = row.querySelector('.row-time').innerText;
                                const title = row.querySelector('.row-title').innerText;
                                const content = row.querySelector('.row-content').innerText;
                                const note = row.querySelector('.row-note').innerText;
                                if (!time && !title) return null;
                                
                                return new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph({ text: time, alignment: AlignmentType.CENTER })], verticalAlign: VerticalAlign.CENTER }),
                                        new TableCell({ children: [
                                            new Paragraph({ children: [new TextRun({ text: title, bold: true })] }),
                                            ...content.split('\n').map(l => new Paragraph({ text: l, spacing: { before: 50 } }))
                                        ]}),
                                        new TableCell({ children: [new Paragraph(note)] })
                                    ]
                                });
                            }).filter(r => r !== null)
                        ]
                    }),
                    new Paragraph({ text: "" }),
                    
                    // Table 4: Footer (Assessment Only)
                    new Table({
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        rows: [
                            new TableRow({ children: [ createCell("æ•™å¸«è©•ä¼°", true, "E5E7EB"), createCell(getT('assessment')) ]})
                        ]
                    })
                ]
            }]
        });
        
        const blob = await Packer.toBlob(doc);
        saveAs(blob, `${getT('topic') || 'æ•™æ¡ˆ'}.docx`);
    };
</script>
</body>
</html>